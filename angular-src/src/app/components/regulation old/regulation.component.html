<div class="container">

  <mat-form-field>
    <h3>{{week}}</h3>
    <input matInput [matDatepicker]="picker" placeholder="Choose a date" [(ngModel)]="picker_date" (dateChange)="setDate()">
    <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
    <mat-datepicker #picker></mat-datepicker>
  </mat-form-field>    

  <h1 class="main-heading">Regulation choice</h1>
  <h2 *ngIf="week">Week {{week}}</h2>
  <div type="range" id="slider"></div>
  <p *ngIf="totally_completed">You have already completed this part of the experiment.</p>
  <p *ngIf="!week && !totally_completed">Please return on the correct date</p>


  <mat-tab-group *ngIf="week && !totally_completed" dynamicHeight [selectedIndex]="main_tab" (selectedIndexChange)="main_tab = $event;" (animationDone)="mainTab()">
    <mat-tab label="Part 1"  [disabled]="parts[0].completed">

      <div class="tab-content input-content">
        <div *ngFor="let choice of regulation_choices; let index = index">
          <h1 style="font-weight:normal;margin-top:80px;">{{choice.name}}</h1>
          <p>Task rate: 1:{{choice.exchange_rate}}</p>
          <div *ngIf="!parts[0].completed">
            <canvas [id]="choice.chartId"></canvas>
            <p style="text-align:center;margin-bottom:0;margin-top:25px;">Set your prefered lower limit on tasks in week 2.</p>
            <div style="display:flex;justify-content:space-between;margin-top:20px;text-align:center;">
              <span>Week 2<br><strong>{{choice.choice}}</strong> </span>
            </div>
            <p *ngIf="choice.choice == null" style="width:96.5%;text-align:center;margin-left:3.5%;font-weight:300;font-size:0.8em;margin-bottom:0;">Click and drag on the line below</p>
            <input class="reverseSlider" [ngClass]="choice.choice == null ? 'idle_slider' : ''" type="range" min="0" max="50" step="1" [(ngModel)]="choice.choice" (input)="regulationChange(index)" style="flex:1;width:96.5%;margin-left:3.5%;margin-top:20px;" [id]="'regulation'+index" [name]="'regulation'+index" (click)="choice.choice = choice.choice == null ? 25 : choice.choice;regulationChange(index);" onclick="blur(this)">
            <p *ngIf="choice.choice" style="text-align:center;font-weight:300;font-size:0.8em;">If you do not wish to restrict the choice of the worker, move the slider to the far right.</p>
            <p style="text-align:center;margin-top:50px;margin-bottom:0;">Set a suggested minimum if you wish</p>
            <div style="display:flex;justify-content:space-between;margin-top:20px;text-align:center;">
              <span>Week 2<br><strong>{{choice.suggestion_min}}</strong> </span>
            </div>
            <input type="range" min="0" max="50" class="reverseSlider" [ngClass]="choice.suggestion_min == null ? 'idle_slider' : ''" style="flex:1;width:96.5%;margin-left:3.5%;margin-top:20px;" [(ngModel)]="choice.suggestion_min" (input)="suggestionChange(index)" (click)="choice.suggestion_min = choice.suggestion_min == null ? 25 : choice.suggestion_min;suggestionChange(index)" onclick="blur(this)">
            <p *ngIf="choice.suggestion_min" style="text-align:center;font-weight:300;font-size:0.8em;">Move the slider to the far right if you do not wish to suggest a minimum</p>
          </div>
        </div>
        <div class="button-box">
          <button [disabled]="regulation_choices[0].choice == null || regulation_choices[1].choice == null || regulation_choices[2].choice == null || regulation_choices[3].choice == null || regulation_choices[4].choice == null" class="active-button" mat-raised-button (click)="submit(0)">Submit</button>
          <p *ngIf="regulation_choices[0].choice == null || regulation_choices[1].choice == null || regulation_choices[2].choice == null || regulation_choices[3].choice == null || regulation_choices[4].choice == null">Please make a regulation choice in all of the above</p>
        </div>
      </div>
    </mat-tab>

    <mat-tab label="Part 2" [disabled]="!parts[0].completed || parts[1].completed">
      <div class="input-content tab-content">
          <p>Here we will ask Lorem ipsum dolor sit amet consectetur, adipisicing elit. Culpa possimus vel, ipsam minus iure quae neque perspiciatis libero unde consequuntur!</p>
          <div *ngFor="let choice of optimal_choices; let index = index;">
            <div [class]="'choice-head'+index">
              <h1 style="font-weight:normal">{{choice.name}}</h1>
              <p>Task rate: 1:{{choice.exchange_rate}}</p>
            </div>

            <div *ngIf="!parts[1].completed && parts[0].completed">
                <div style="width:100%;">
                  <div style="position:relative;">
                    <mat-card *ngFor="let optimal of choice.choices; let opt_index = index" style="margin-right:5px;margin-bottom:10px;min-width:380px;padding:30px;" [ngClass]="'card'+index+'_'+opt_index">
                      <mat-card-header>
                        <mat-card-title>{{optimal.name}}</mat-card-title>
                        <mat-card-subtitle>{{choice.name}}</mat-card-subtitle>
                      </mat-card-header>
                      <mat-card-content style="text-align:center;">
                        <mat-icon style="width:50%;text-align:center;font-size:100px;">face</mat-icon>
                        <div style="margin-top:20px;">
                            "I choose to do <strong>{{optimal.worker_w2_choice}}</strong> tasks in week 2 and <strong>{{optimal.worker_w3_choice}}</strong> tasks in week 3"
                        </div>
                        <canvas style="margin-top:20px;" [id]="choice.chartId[opt_index]"></canvas>
                        <p style="margin-bottom:0;">Which choice do you think makes this person better off <em>in the long run</em>?</p>     
                        <div style="display:flex;justify-content:space-between;margin-top:30px;text-align:center;">
                          <span>Week 2<br><strong>{{optimal.input}}</strong></span>
                          <span>Week 3<br><strong>{{choice.w3_options[optimal.input]}}</strong></span>
                        </div>
                        <p *ngIf="optimal.input == null" style="width:96.5%;text-align:center;margin-left:3.5%;font-weight:300;font-size:0.8em;margin-bottom:0;">Click and drag on the line below</p>
                        <input class="reverseSlider" [ngClass]="optimal.input == null ? 'idle_slider' : ''" type="range" min="0" max="50" step="1" [id]="'optimal'+index" [name]="'optimal'+index" style="width:95%;margin-left:5%;margin-top:20px;" [(ngModel)]="optimal.input" (input)="optimalChange(index, opt_index)" (click)="optimal.input = optimal.input == null ? 25 : optimal.input; optimalChange(index,opt_index)" onclick="blur(this)">
                      </mat-card-content>
                    </mat-card>
                  </div>
                </div>
            </div>
          </div>
          <div class="button-box">
            <button class="active-button" mat-raised-button (click)="submit(1)" [disabled]="optimal_choices[0].choices[0].input == null || optimal_choices[0].choices[1].input == null || optimal_choices[0].choices[2].input == null || optimal_choices[0].choices[3].input == null || optimal_choices[0].choices[4].input == null || optimal_choices[0].choices[5].input == null || optimal_choices[1].choices[0].input == null || optimal_choices[1].choices[1].input == null || optimal_choices[1].choices[2].input == null || optimal_choices[1].choices[3].input == null || optimal_choices[1].choices[4].input == null || optimal_choices[1].choices[5].input == null">Submit</button>
          </div>
        </div>

    </mat-tab>

    <mat-tab label="Part 3" [disabled]="!parts[1].completed || parts[2].completed">

        <div class="input-content tab-content">
            <p style="margin-top:30px;">
              Here we will ask you to make a guess about the percentage of workers in the experiment who will choose within different categories. For each choice 
                we will ask you what percentage of participants you think will choose <em>at most</em> (up to and including) that amount. One of your answers below will be randomly selected 
                to determin a bonus, which you will recieve. The size of your bonus will be 100 DKK minus 1 DKK for each percentage point your answer differs from the actaul 
                percentage of participants. As an example, if you guess that 30% of the workers will choose to do at most 20 tasks in week 2 in choice 1 and the actual 
                percentage is 10%, then you recive a bonus of 100 DKK - (30 - 10) DKK = 80 DKK.<br><br>
                Notice that we have made it so that you cannot give a lower answer further down the list. This is due to the fact that if you guess that 20% will choose 
                at least 30 tasks, then it doesn't make sense to answer that less then 20% will choose at most 40 tasks.
            </p>
            <div *ngFor="let choice of distribution_choices; let index = index" style="margin-top:40px;">
              <h1 style="font-weight:normal">{{choice.name}}</h1>
              <p>Task rate: 1:{{choice.exchange_rate}}</p>
              <div *ngIf="!parts[2].completed">
                
                <div style="width:100%;margin-top:70px;margin-bottom:30px;" *ngFor="let belief of choice.distribution_beliefs; let i = index;">
                  <div style="margin-bottom:50px;"><canvas [id]="choice.chartId[i]"></canvas></div>
                  <label>What percentage do you think will choose: <strong>{{belief.name}}</strong> in week 2?</label>
                  <div [style.padding-left]="belief.min+'%'">
                    <p *ngIf="belief.input == null" style="width:96.5%;text-align:center;margin-left:3.5%;font-weight:300;font-size:0.8em;margin-bottom:0;">Click and drag on the line below</p>
                    <input class="dist_slider" [ngClass]="belief.input == null ? 'idle_slider' : ''" [min]="belief.min" max="100" style="width:100%;" type="range" [id]="'belief'+index+'_'+i" [(ngModel)]="belief.input" (mouseup)="updateDistribution(index)" onclick="blur(this)">
                  </div>
                  <p>Your choice: <strong>{{belief.input}}%</strong></p>
                </div>
                <div style="width:100%;padding:20px;border:3px solid black;">
                  <h3 *ngIf="!belief_done[index]" style="width:100%;text-align:center;">You have not completed all choices above</h3>
                  <div *ngIf="belief_done[index]">
                    <h3 *ngIf="belief_done[index]" >Your chosen distribution</h3>
                    <div *ngIf="belief_done[index]" style="width:100%;height:150px;display:flex;margin-bottom:20px;">
                      <div *ngFor="let belief of choice.beliefs_calculated; let ind = index;" [style.flex]="belief.value" style="display:flex;height:100%;">
                        <div [style.background]="belief_colors[ind]" style="height:100%;flex:1;"></div>
                      </div>
                    </div>
                    <div style="width:100%;margin-bottom:20px;">
                      <div *ngFor="let belief of choice.beliefs_calculated; let j = index">
                        <mat-chip [style.background]="belief_colors[j]" style="width:61px;" [ngStyle]="{'color': j > 1 ? 'white' : 'black'}">
                          {{belief.name}}
                        </mat-chip>
                        <mat-icon *ngFor="let face of ' '.repeat(belief.value).split('')">accessibility</mat-icon>
                      </div>
                    </div>
                    <mat-chip-list>
                      <mat-chip style="width:180px;" *ngFor="let dist of choice.beliefs_calculated; let j = index" [style.background]="belief_colors[j]" [ngStyle]="{'color': j > 1 ? 'white' : 'black'}">
                        {{dist.name}} :<span *ngIf="j==0 || j==6">&nbsp; &nbsp; &nbsp; &nbsp;</span> <span *ngIf="j==1">&nbsp;</span> <span *ngIf="dist.value<10">&nbsp;</span>
                        <button mat-icon-button (click)="distrClick(index,j,-1)">-</button>
                        {{dist.value}}%
                        <button mat-icon-button (click)="distrClick(index,j,+1)">+</button>
                      </mat-chip>
                    </mat-chip-list>
                    <p>The choices you have made above correspond to the visualisation above. The bar at the top shows the percentages as the area of each color. The chart below with the 
                      <mat-icon>accessibility</mat-icon>-icons shows for each choice how many persons out of 100 you think will make that choice. If you wish, you can use the buttons above 
                      to adjust the distribution of choices.
                    </p>
                  </div>
                </div>
              </div>
          </div>
          <div class="button-box">
            <p *ngIf="!belief_done">Please complete all choices in order to move forward in the experiment.</p>
            <button [disabled]="!belief_done[0] || !belief_done[1]" class="active-button" mat-raised-button (click)="submit(2)">Submit</button>
          </div>
        </div>
    </mat-tab>
    <mat-tab label="Part 4" [disabled]="!parts[2].completed || parts[3].completed">
      <div class="input-content tab-content">
        <h3 style="text-align: center;">How happy are you with the regulation you have set?</h3>
        <div style="display:flex;">
          <mat-icon style="transform: scale(2);padding:20px;">sentiment_very_dissatisfied</mat-icon>
          <input [(ngModel)]="satisfaction" class="dist_slider" [ngClass]="satisfaction == null ? 'idle_slider' : ''" [min]="0" max="10" style="width:100%;" type="range" onclick="blur(this)">
          <mat-icon style="transform: scale(2);padding:20px;">sentiment_very_satisfied</mat-icon>
        </div>
      </div>
      <div class="input-container" style="text-align: left;">
        <p>Please explain why you made the regulation choices that you did</p>
        <textarea [(ngModel)]="free_text" style="width:100%;height:300px;padding:12px 20px; box-sizing:border-box;resize:none;border:2px solid #ccc;font-size:16px;font-family:'Roboto'" placeholder="Input answer here"></textarea>
      </div>
      <div class="input-container" style="text-align: left; margin-top:50px;">
        <p>Do you wish to add 50 DKK to the total earnings of another worker (not the one you have regulated)?</p>
        <mat-radio-group color="warn" [(ngModel)]="help" aria-label="Do you wish to add 50 DKK to the total earnings of another worker (not the one you have regulated)?">
          <mat-radio-button style="margin-left:10px;" value="yes">Yes</mat-radio-button><br>
          <mat-radio-button value="no" style="margin-left:10px;margin-top:10px;">No</mat-radio-button>
        </mat-radio-group>
      </div>
      <div class="input-container" style="text-align: left; margin-top:50px;">
        <p>Do you wish to subtract 50 DKK from the total earnings of a third worker (not the one you have regulated and not the one you affect above)</p>
        <mat-radio-group color="warn" [(ngModel)]="harm" aria-label="Do you wish to add 50 DKK to the total earnings of another worker (not the one you have regulated)?">
          <mat-radio-button style="margin-left:10px;" value="yes">Yes</mat-radio-button><br>
          <mat-radio-button value="no" style="margin-left:10px;margin-top:10px;">No</mat-radio-button>
        </mat-radio-group>
      </div>
      <div class="button-box">
        <p *ngIf="!belief_done">Please complete all choices in order to move forward in the experiment.</p>
        <button class="active-button" mat-raised-button (click)="submit(3)">Submit</button>
      </div>

    </mat-tab>

  </mat-tab-group>

</div>